<!DOCTYPE html>

<head>
    <link rel="stylesheet" type="text/css" href="/ssp_new/themes/default/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/ssp_new4/themes/default/css/pages/adRegionPriceDetail.css" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style type="text/css">
    .body {
        width: 800px;
        margin: 0 auto;
    }
    
    .region-select {
        overflow: hidden;
    }
    
    .selected-list {
        width: 45%;
        height: 160px;
        border: 1px solid;
        float: left;
    }
    
    .selected-item {}
    
    .selected-item li {
        overflow: hidden;
        width: 40%;
    }
    
    .selected-item > li > span {
        float: left;
        display: block;
        margin: 2px;
    }
    
    .selected-subItem {
        overflow: hidden;
    }
    
    .selected-subItem li {
        width: auto;
        float: left;
        margin: 2px;
    }
    
    .region-list {
        width: 54%;
        float: right;
    }
    
    .region-items {
        /* 		overflow: hidden;
	 */
    }
    
    .region-items > li {
        float: left;
    }
    
    .region-items button {
        width: 18px;
        height: 18px;
    }
    
    .region-subItems {
        position: relative;
    }
    
    .region-subItems ul {
        position: absolute;
        border: 1px solid;
        z-index: 100;
        padding: 5px;
        width: 200px;
        background: #fff;
    }
    
    .region-subItems li {
        float: left;
        padding: 2px 2px;
        width: 80px;
    }
    </style>
    <script src="http://localhost/ssp_new2/js/libs/knockout-2.2.1.js"></script>
    <script src="http://localhost/ssp_new2/js/libs/knockout.mapping.min.js"></script>
    <script src="http://localhost/ssp_new2/assets/c0937cae/jquery.js"></script>
</head>

<body>
    <script src="city.js"></script>
    <div id="cityContainer">
        <ul data-bind="foreach:$data.data">
            <li>
                <label>
                    <input type="checkbox" value="value" data-bind="checked:$data.isChecked"><span data-bind="text:label"></span></label>
               	 <!--ko if:$data.children-->	
               	 <li class="select-all">
                        <label>
                            <input type="checkbox"  data-bind="checked:$data.isChecked"><span>全选</span>
                        </label>
                        <a href="javascript:(0)" data-bind="click:close">关闭</a>
                	</li>
               
                <ul style="padding-left:20px" data-bind="foreach:children">
 
                    <li>
                        <label>
                            <input type="checkbox" value="" data-bind="checkedValue:$parent.selectedItems,checked:$parent.selectedItems,value:id"><span data-bind="text:label"></span></label>
                    </li>
                </ul>
                <!--/ko-->
            </li>
        </ul>
    </div>
    <script>
    ;
    (function() {
        var _xtree = function(name) {
            this._vm = {
                mapLeafs: [],
                mapCodeTree: {},
                mapCodeName: {}
            };
        }
        _xtree.prototype = {
            init: function(datas) {
                this._vm.data = datas;
                return this.setVm(this._vm.data, null);
            },
            /** [setVm description]
             *  setFunc(data,isChild)	
             */
            setVm: function(data, parent, setFunc) {
                var self = this;
                var i = 0;
                ko.utils.arrayForEach.call(self, data, function(item) {

                    item.index = i;
                    if (parent) {
                        item.parentIndex = parent.index;
                        item.path = parent.path + ',' + i;
                        /*						if(!self._vm.mapCodeTree[parent.id])
                        						{
                        							self._vm.mapCodeTree[parent.id]=[];
                        						}
                        						self._vm.mapCodeTree[parent.id].push(item.id);*/
                    } else {
                        item.path = i;
                    }

                    if ('children' in item){
                        item.selectedItems = ko.observableArray([]);
                        item._selectedState = ko.observable(0);
                        item._isChecked = ko.observable(false);
                        item.isChecked = ko.computed({
                        	read:function(){
                        		return item.selectedItems().length == item.children.length;
                        	},
							write:function(val){
								if(val && item.selectedItems().length< item.children.length){
									item.selectedItems([]);
									for(var i=0;i < item.children.length;i++){
										item.selectedItems.push(item.children[i].id);
									}
								}
								else if(!val && item.selectedItems().length>0){
										item.selectedItems([]);
								}
							}
                        });
                        item.clickNode = function(){

                        }

                        self.setVm(item.children, item, setFunc);

                    } else {
                        //item.path+=',';//叶节点结束加,防止搜索时15和152混淆
                        self._vm.mapLeafs.push(item.path);
                    }

                    self._vm.mapCodeName[item.id] = {
                        id: item.id,
                        label: item.label,
                        path: item.path
                    };
                    i++;
                });



                this._vm.getSelectItems = function(data) {
                    /*				var selectedItems = [];
                    				ko.utils.arrayForEach(data,(function(self){
                    					return function(item){
                    						if('selectedItems' in item){
                    							selectedItems.push(item.selectedItems());
                    						}else if(item.level==1){
                    							setSelectItems.push(item.code);
                    						}
                    					}
                    				})(data));
                    				return selectedItems;*/
                };

                this._vm.getShowSelectItems = function() {

                }

                data.setSelectItems = function() {}

                return this._vm;
            }

        }

        var tree = new _xtree();
        var cityVm = tree.init(cityData.data.helper, []);
        console.log('cityData', cityVm);
        ko.applyBindings(cityVm);
    })();
    </script>
</body>

</html>
